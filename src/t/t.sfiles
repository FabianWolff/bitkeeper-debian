# Copyright 1999-2012,2014-2016 BitMover, Inc

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at

#     http://www.apache.org/licenses/LICENSE-2.0

# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
 
CFS=@

echo $N Setup .......................................................$NL
set -e
trap 'echo failed' 0
commercial project
mkdir bar
mkdir bar/blech
touch foo
touch s.foo
touch bar/s.foo
touch bar/blech/s.foo
bk delta $Q -i foo s.foo bar/s.foo bar/blech/s.foo
bk _touch SCCS/c.gone "SCCS/c.gone${CFS}1.1" "SCCS/c.gone${CFS}1.2" \
	bar/SCCS/c.s.foo
trap '' 0
set +e
echo OK

echo $N Check -0 does null termination of files in list .............$NL
# Want null termination
perl -e 'print "SCCS/s.ChangeSet\0SCCS/s.foo\0SCCS/s.s.foo\0"' > WANT
bk sfiles -0 -1 > GOT
checkfiles WANT GOT
rm -f WANT GOT
echo OK

echo $N Check explicit list with some files left out ................$NL
sort <<EOF > X
ChangeSet
s.foo
bar/blech/s.foo
EOF
bk undos X > .sfiles
rm -f X
bk gfiles `cat .sfiles` | sort > GOT
sort <<EOF > WANT
ChangeSet
s.foo
bar/blech/s.foo
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Check the list of SCCS files ................................$NL
bk sfiles | sort > GOT
sort <<EOF > WANT
SCCS/s.ChangeSet
BitKeeper/etc/SCCS/s.attr
BitKeeper/etc/SCCS/s.collapsed
BitKeeper/etc/SCCS/s.config
BitKeeper/etc/SCCS/s.gone
BitKeeper/etc/SCCS/s.ignore
SCCS/s.foo
SCCS/s.s.foo
bar/SCCS/s.s.foo
bar/blech/SCCS/s.s.foo
EOF
cmpfiles GOT WANT
echo OK

echo $N Check explicit list with some files left out ................$NL
sort <<EOF > X
ChangeSet
s.foo
bar/blech/s.foo
EOF
bk undos X > .sfiles
rm -f X
bk gfiles `cat .sfiles` | sort > GOT
sort <<EOF > WANT
ChangeSet
s.foo
bar/blech/s.foo
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Check the list of g-files ...................................$NL
bk sfiles -g | sort > GOT
sort <<EOF > WANT
ChangeSet
BitKeeper/etc/attr
BitKeeper/etc/collapsed
BitKeeper/etc/config
BitKeeper/etc/gone
BitKeeper/etc/ignore
foo
s.foo
bar/s.foo
bar/blech/s.foo
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; sdiff -w80 GOT WANT; exit 1; fi
bk sfiles -g - < .sfiles | sort > GOT
sort <<EOF > WANT
ChangeSet
s.foo
bar/blech/s.foo
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo list failed; sdiff -w80 GOT WANT; exit 1; fi
echo OK

echo $N Check the list of pending files .............................$NL
bk gfiles -pC | sort > GOT
sort <<EOF > WANT
foo${BK_FS}1.1
s.foo${BK_FS}1.1
bar/s.foo${BK_FS}1.1
bar/blech/s.foo${BK_FS}1.1
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
# XXX -pC cannot be used with file lists.
#bk sfiles -pC - < .sfiles | sort > GOT
#sort <<EOF > WANT
#SCCS/s.ChangeSet${BK_FS}1.1
#SCCS/s.s.foo${BK_FS}1.1
#SCCS/bar/blech/s.s.foo${BK_FS}1.1
#EOF
#cmp -s GOT WANT
#if [ $? -ne 0 ]; then echo list failed; diff GOT WANT; exit 1; fi
echo OK

bk commit $Q -yblah - <GOT
bk co $Q -l s.foo bar/s.foo
ls >> bar/s.foo
echo hi | bk cfile save bar/s.foo
echo $N Check the list of changed files .............................$NL
bk gfiles -c > GOT
cat <<EOF > WANT
bar/s.foo
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
bk gfiles -c - < .sfiles | sort > GOT
sort <<EOF > WANT
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo list failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Check the list of locked files ..............................$NL
bk gfiles -l | sort > GOT
sort <<EOF > WANT
s.foo
bar/s.foo
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
bk gfiles -l - < .sfiles | sort > GOT
sort <<EOF > WANT
s.foo
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo list failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Check the list of unlocked files ............................$NL
bk gfiles -u | sort > GOT
sort <<EOF > WANT
BitKeeper/etc/attr
BitKeeper/etc/collapsed
BitKeeper/etc/config
BitKeeper/etc/gone
BitKeeper/etc/ignore
ChangeSet
foo
bar/blech/s.foo
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo list failed; diff GOT WANT; exit 1; fi
bk gfiles -u - < .sfiles | sort > GOT
sort <<EOF > WANT
ChangeSet
bar/blech/s.foo
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo list failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Check sfiles -ycdxGijlnsRuDp aka -E without -v ..............$NL
sort <<EOF > WANT
.
BitKeeper
bar
BitKeeper/deleted
BitKeeper/etc
SCCS/c.gone
SCCS/c.gone@1.1
SCCS/c.gone@1.2
ChangeSet
foo
s.foo
WANT
.sfiles
GOT
BitKeeper/etc/attr
BitKeeper/etc/collapsed
BitKeeper/etc/config
BitKeeper/etc/gone
BitKeeper/etc/ignore
bar/blech
bar/s.foo
bar/blech/s.foo
EOF
bk gfiles -ycdxGijlnsRuDp | sort > GOT || fail
cmpfiles WANT GOT
echo OK

echo $N Check sfiles -vE ............................................$NL
bk _touch SCCS/JUNK
sort <<EOF > WANT
d------ .
D------ BitKeeper
d------ bar
D------ BitKeeper/deleted
d------ BitKeeper/etc
su----- ChangeSet
su----- foo
sl--G-- s.foo
x------ WANT
x------ .sfiles
x------ GOT
j------ SCCS/JUNK
j------ SCCS/c.gone
j------ SCCS/c.gone@1.1
j------ SCCS/c.gone@1.2
su----- BitKeeper/etc/attr
su----- BitKeeper/etc/collapsed
su--G-- BitKeeper/etc/config
su--G-- BitKeeper/etc/gone
su--G-- BitKeeper/etc/ignore
d------ bar/blech
slc-G-y bar/s.foo
su----- bar/blech/s.foo
EOF
bk gfiles -vE | sort > GOT || fail
cmpfiles WANT GOT
echo OK

echo $N Check the list of clean, unlocked files .....................$NL
bk ci $Q -l -yfoo bar/s.foo
# We used to do this as a side-effect of a delta; no more.  Not our data.
bk _rm bar/SCCS/c.s.foo
ls -R >bar/s.foo
bk ci $Q -mfoo-R bar/s.foo
bk ci $Q -mblech s.foo
bk gfiles -u | sort > GOT
sort <<EOF > WANT
BitKeeper/etc/attr
BitKeeper/etc/collapsed
BitKeeper/etc/config
BitKeeper/etc/gone
BitKeeper/etc/ignore
ChangeSet
foo
s.foo
bar/s.foo
bar/blech/s.foo
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
bk gfiles -u - < .sfiles | sort > GOT
sort <<EOF > WANT
ChangeSet
s.foo
bar/blech/s.foo
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo list failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Check the list of pending files .............................$NL
bk gfiles -pC | sort > GOT
sort <<EOF > WANT
bar/s.foo${BK_FS}1.3
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Check the list of pending files with -pA ....................$NL
bk gfiles -pCA | sort > GOT
sort <<EOF > WANT
bar/s.foo${BK_FS}1.2
bar/s.foo${BK_FS}1.3
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Commit work, check pending lists again ......................$NL
bk sfiles -pC | bk commit $Q -ysecond -
bk sfiles -pC | sort > GOT
if [ -s GOT ]; then echo "Failed (short)"; cat GOT; exit 1; fi
bk sfiles -pCA | sort > GOT
if [ -s GOT ]; then echo "Failed (long)"; cat GOT; exit 1; fi
echo OK

echo $N Look for directories under SCCS control .....................$NL
mkdir -p bar/not bar/notquite/SCCS
bk sfiles -d | sort > GOT
sort <<EOF > WANT
.
bar
bar/blech
BitKeeper/etc
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Look for directories not under SCCS control .................$NL
bk sfiles -D | grep -v BitKeeper | sort > GOT
sort <<EOF > WANT
bar/not
bar/notquite
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Check the list of extra files ...............................$NL
rm -f .sfiles
mkdir foo
touch foo/bar
bk sfiles -jx | sort > GOT
sort <<EOF > WANT
foo/bar
WANT
GOT
SCCS/JUNK
SCCS/c.gone
SCCS/c.gone${CFS}1.1
SCCS/c.gone${CFS}1.2
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
X=`bk sfiles -x WANT SCCS/s.foo`
if [ "X$X" != "XWANT" ]; then echo failed; echo $X; exit 1; fi
echo OK

echo $N Test -x in a subdirectory ...................................$NL
cd foo
bk sfiles -x > ../GOT
cat <<EOF > WANT
bar
EOF
cmpfiles WANT ../GOT
cd ..
rm -rf foo
echo OK

echo $N Make sure garbage in SCCS dir behaves .......................$NL
bk _touch SCCS/OLD-s.foo
bk sfiles -jx | sort > GOT
sort <<EOF > WANT
WANT
SCCS/OLD-s.foo
SCCS/JUNK
GOT
SCCS/c.gone
SCCS/c.gone${CFS}1.1
SCCS/c.gone${CFS}1.2
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; cat GOT; exit 1; fi
X=`bk sfiles -jx SCCS/OLD-s.foo`
if [ "X$X" != "XSCCS/OLD-s.foo" ]; then echo failed; echo $X; exit 1; fi
echo OK

test works = does_not_work && {
echo $N Make sure leftover c.files are seen as jy w/ -v .............$NL
touch SCCS/c.NO_SUCH_FILE
bk sfiles -vjyx SCCS/c.NO_SUCH_FILE > GOT
echo j------ SCCS/c.NO_SUCH_FILE > WANT
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; cat GOT; exit 1; fi
echo OK
}

echo $N Make sure sfiles GFILE lists SCCS/s.GFILE ...................$NL
if bk _test -f s.foo; then exit 1; fi
if bk _test ! -f SCCS/s.s.foo; then exit 1; fi
FOO="`bk sfiles -s s.foo`"
if [ "$FOO" != "SCCS/s.s.foo" ]; then echo Failed - got $FOO.; exit 1; fi
echo OK

echo $N Test ignore lists with -jx...................................$NL
bk edit $Q BitKeeper/etc/ignore
cat <<EOF > BitKeeper/etc/ignore
Desktop.ini
WANT
s.*
*ore
config
EOF
sort <<EOF > WANT
SCCS/OLD-s.foo
SCCS/JUNK
GOT
SCCS/c.gone
SCCS/c.gone${CFS}1.1
SCCS/c.gone${CFS}1.2
EOF
bk sfiles -jx | sort > GOT
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Test that read-only BitKeeper/etc ignores correctly .........$NL
bk delta -ywhatever $Q BitKeeper/etc/ignore
bk clean BitKeeper/etc
if [ $PLATFORM != "WIN32" ]
then
chmod 550 BitKeeper/etc
bk -r clean
bk sfiles -jx | sort > GOT
cmpfiles GOT WANT
chmod 775 BitKeeper/etc
echo OK
else
echo skipped
fi
bk co $Q BitKeeper/etc
bk edit $Q BitKeeper/etc/ignore

echo $N Test disabling ignore lists with -au ........................$NL
sort <<EOF > WANT
BitKeeper/etc/attr
BitKeeper/etc/collapsed
BitKeeper/etc/config
BitKeeper/etc/gone
ChangeSet
foo
s.foo
bar/s.foo
bar/blech/s.foo
EOF
bk gfiles -au | sort > GOT
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Test disabling ignore lists with -ajx .......................$NL
sort <<EOF > WANT
WANT
SCCS/OLD-s.foo
SCCS/JUNK
GOT
SCCS/c.gone
SCCS/c.gone${CFS}1.1
SCCS/c.gone${CFS}1.2
EOF
bk sfiles -ajx | grep -v Desktop.ini | sort > GOT
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
echo OK

echo $N Test that tree walk does not follow symlinks ................$NL
if [ $PLATFORM = "WIN32" ]
then
	echo skipped
else
#----------------------------------------------------------- 
ln -s /usr/lib bar/lib || { echo ln failed; exit 1; }
sort <<EOF > WANT
SCCS/OLD-s.foo
SCCS/JUNK
GOT
bar/lib
SCCS/c.gone
SCCS/c.gone${CFS}1.1
SCCS/c.gone${CFS}1.2
EOF
bk sfiles -jx | sort > GOT
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
rm -f bar/lib
echo OK
#----------------------------------------------------------- 
fi

echo $N Test naive mode with s.files in odd places ..................$NL
date > impostor
bk ci $Q -i -m'boo!' impostor
bk co $Q impostor
bk _mv SCCS/s.impostor s.impostor
bk _mv impostor SCCS/s.impostor
bk gfiles | sort > GOT
sort <<EOF > WANT
BitKeeper/etc/attr
BitKeeper/etc/collapsed
BitKeeper/etc/config
BitKeeper/etc/gone
BitKeeper/etc/ignore
s.foo
bar/s.foo
bar/blech/s.foo
foo
ChangeSet
impostor
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
echo OK

if false
then
	# This is disabled until I fix sfind_main() to handle it.
	# I'm trying to kill sfiles.
echo $N Test mildly paranoid mode ...................................$NL
bk sfiles -P | sort > GOT
sort <<EOF > WANT
BitKeeper/etc/SCCS/s.attr
BitKeeper/etc/SCCS/s.collapsed
BitKeeper/etc/SCCS/s.config
BitKeeper/etc/SCCS/s.gone
BitKeeper/etc/SCCS/s.ignore
SCCS/s.s.foo
bar/SCCS/s.s.foo
bar/blech/SCCS/s.s.foo
SCCS/s.foo
SCCS/s.ChangeSet
SCCS/s.impostor
s.impostor
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; sdiff -w80 GOT WANT; exit 1; fi
echo OK

# XXX - this is just the same as -P
echo $N Test truly paranoid mode ....................................$NL
bk sfiles -PP
bk sfiles -PP | sort > GOT
sort <<EOF > WANT
BitKeeper/etc/SCCS/s.attr
BitKeeper/etc/SCCS/s.collapsed
BitKeeper/etc/SCCS/s.config
BitKeeper/etc/SCCS/s.gone
BitKeeper/etc/SCCS/s.ignore
SCCS/s.s.foo
bar/SCCS/s.s.foo
bar/blech/SCCS/s.s.foo
SCCS/s.foo
SCCS/s.ChangeSet
s.impostor
EOF
cmp -s GOT WANT
if [ $? -ne 0 ]; then echo failed; diff GOT WANT; exit 1; fi
echo OK
fi

echo $N Test sfile -cGjlnvxyp with s.file w no pathname .............$NL
# create a s.file which has no pathname
bk _scat SCCS/s.foo | perl -ne 'print unless /^.cP/' | bk undos > s.bad
bk _mv s.bad SCCS/s.bad
bk admin -z  SCCS/s.bad
bk _rm -f SCCS/s.impostor SCCS/d.impostor
bk sort -k1 > "$HERE/WANT" <<EOF
j------ SCCS/JUNK
j------ SCCS/OLD-s.foo
j------ SCCS/c.gone
j------ SCCS/c.gone@1.1
j------ SCCS/c.gone@1.2
sl-pG-- BitKeeper/etc/ignore
su---n- bad
su--G-- BitKeeper/etc/attr
su--G-- BitKeeper/etc/collapsed
su--G-- BitKeeper/etc/config
su--G-- BitKeeper/etc/gone
x------ GOT
EOF
bk gfiles -cGjlnvxyp | bk sort -k1 > "$HERE/GOT" || { echo failed 1; exit 1; }
cmp -s "$HERE/WANT" "$HERE/GOT" || {
	echo failed 1
	sdiff -w80 "$HERE/WANT" "$HERE/GOT"
	ls SCCS
	exit 1
}
echo OK

echo $N Test sfile -cdDGjlnvxyp with s.file w no pathname ...........$NL
bk sort -k1 > "$HERE/WANT" <<EOF
j------ SCCS/OLD-s.foo
j------ SCCS/JUNK
j------ SCCS/c.gone
j------ SCCS/c.gone@1.1
j------ SCCS/c.gone@1.2
x------ GOT
su--G-- BitKeeper/etc/gone
sl-pG-- BitKeeper/etc/ignore
su--G-- BitKeeper/etc/config
su--G-- BitKeeper/etc/attr
su--G-- BitKeeper/etc/collapsed
su---n- bad
D------ BitKeeper
D------ BitKeeper/deleted
D------ bar/not
D------ bar/notquite
d------ .
d------ BitKeeper/etc
d------ bar
d------ bar/blech
EOF
bk gfiles -cdDGjlnvxyp | bk sort -k1 > "$HERE/GOT" || { echo failed 1; exit 1; }
cmp -s "$HERE/WANT" "$HERE/GOT" || {
	echo failed 2
	sdiff -w80 "$HERE/WANT" "$HERE/GOT"
	exit 1
}
echo OK

echo $N Test limiting sfiles to one level ...........................$NL
bk sort -k1 > "$HERE/WANT" <<EOF
j------ SCCS/OLD-s.foo
j------ SCCS/JUNK
j------ SCCS/c.gone
j------ SCCS/c.gone@1.1
j------ SCCS/c.gone@1.2
x------ GOT
su---n- bad
D------ BitKeeper
d------ .
d------ bar
EOF
bk gfiles -1cdDjlnvxyp | bk sort -k1 > "$HERE/GOT" || { echo failed 1; exit 1; }
cmp -s "$HERE/WANT" "$HERE/GOT" || {
	echo failed 2
	sdiff -w80 "$HERE/WANT" "$HERE/GOT"
	exit 1
}
echo OK

echo $N Test sfile -U with triggers, they should be listed ..........$NL
cd "`bk root`"
test -d BitKeeper/triggers || mkdir BitKeeper/triggers
echo exit 0 > BitKeeper/triggers/pre-commit
chmod +x BitKeeper/triggers/pre-commit
bk new $Q BitKeeper/triggers/pre-commit
bk sfiles -gU | grep -q BitKeeper/triggers/pre-commit || {
	echo failed to list trigger
	bk sfiles -gU
	exit 1
}
echo OK

echo $N Test sfiles -c outside of repo ..............................$NL
cd "$HERE"
mkdir -p foo/SCCS
cd foo
date > file
bk new $Q file
bk edit $Q file
date >> file
bk sfiles -cg > out || fail
cat <<EOF > want
file
EOF
cmpfiles out want
echo OK

cores

# LM's new testing starts here
# -d (BK directories)
# -D (Non BK directories)
# -i (extras but ignored)
# -j (junk in the SCCS directory with and without comments)
# -R (BK subrepos)
# -s (just sfiles - XXX is this needed?)
# -x (extras)
# -ax (extras not considering the ignore list)
# -l (locked sfiles)
# -u (unlocked sfiles)
# -c (changed sfiles)
# -p (pending sfiles)
# -G (checked out sfiles)
# -n (files in the wrong location)
# -y (sfiles with comments)
# All of the above with and without -v
# All of the above as recursive thing and with naming the file in argv

echo $N Set up for unit testing .....................................$NL
cd "$HERE"
commercial lmtest
commercial subrepo
cd "$HERE/lmtest"
mkdir DIR_WITH_SCCS
mkdir DIR_WITH_NO_SCCS
touch EXTRA1 EXTRA_WITH_COMMENTS DIR_WITH_NO_SCCS/EXTRA2 DIR_WITH_SCCS/EXTRA3
touch ignored.o
bk _touch SCCS/JUNK SCCS/c.NO_SFILE_NO_GFILE SCCS/c.EXTRA_WITH_COMMENTS
cd DIR_WITH_SCCS
touch NORMAL PENDING MODIFIED LOCKED UNLOCKED GOTTEN NAME MODIFIED_W_COMMENTS
bk new $Q NORMAL PENDING MODIFIED LOCKED UNLOCKED GOTTEN NAME MODIFIED_W_COMMENTS
bk ignore '*.o'
bk commit $Q -ywhatever || fail
bk edit $Q LOCKED PENDING MODIFIED MODIFIED_W_COMMENTS
bk delta $Q -fywhatever PENDING
echo foo > MODIFIED
echo foo > MODIFIED_W_COMMENTS
bk co $Q GOTTEN
bk _mv SCCS/s.NAME SCCS/s.WRONG_NAME
echo comments | bk cfile save MODIFIED_W_COMMENTS
echo OK

echo $N Test summary output .........................................$NL
cat <<EOF > "$HERE/WANT"
    14 files under revision control.
     1 subrepositories.
     4 files not under revision control (and not ignored).
     1 ignored files not under revision control.
     3 directories containing revision controlled files.
     3 directories with no revision controlled files.
     7 files checked out.
     2 files modified and not checked in.
     1 files with checked in, but not committed, deltas.
     1 files in incorrect locations.
EOF
cd "$HERE/lmtest"
bk sfiles -icdDGjnRuSp > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Test summary output from outside the repo ...................$NL
cd "$HERE"
bk sfiles -icdDGjnRuSp lmtest > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Test verbose output for all files ...........................$NL
cd "$HERE/lmtest"
cat <<EOF > "$HERE/WANT"
D------ BitKeeper
D------ BitKeeper/deleted
D------ DIR_WITH_NO_SCCS
R------ subrepo
d------ .
d------ BitKeeper/etc
d------ DIR_WITH_SCCS
i------ ignored.o
j------ SCCS/JUNK
j------ SCCS/c.NO_SFILE_NO_GFILE
sl--G-- DIR_WITH_SCCS/LOCKED
slc-G-- DIR_WITH_SCCS/MODIFIED
slc-G-y DIR_WITH_SCCS/MODIFIED_W_COMMENTS
su----- BitKeeper/etc/attr
su----- BitKeeper/etc/collapsed
su----- ChangeSet
su----- DIR_WITH_SCCS/NORMAL
su----- DIR_WITH_SCCS/UNLOCKED
su---n- DIR_WITH_SCCS/WRONG_NAME
su--G-- BitKeeper/etc/config
su--G-- BitKeeper/etc/gone
su--G-- BitKeeper/etc/ignore
su--G-- DIR_WITH_SCCS/GOTTEN
su-p--- DIR_WITH_SCCS/PENDING
x------ DIR_WITH_NO_SCCS/EXTRA2
x------ DIR_WITH_SCCS/EXTRA3
x------ EXTRA1
x-----y EXTRA_WITH_COMMENTS
EOF
bk gfiles -vixcdDGjnRup | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Test verbose output for all files from outside the repo .....$NL
cd "$HERE"
cat <<EOF > "$HERE/WANT"
D------ lmtest/BitKeeper
D------ lmtest/BitKeeper/deleted
D------ lmtest/DIR_WITH_NO_SCCS
R------ lmtest/subrepo
d------ lmtest
d------ lmtest/BitKeeper/etc
d------ lmtest/DIR_WITH_SCCS
i------ lmtest/ignored.o
j------ lmtest/SCCS/JUNK
j------ lmtest/SCCS/c.NO_SFILE_NO_GFILE
sl--G-- lmtest/DIR_WITH_SCCS/LOCKED
slc-G-- lmtest/DIR_WITH_SCCS/MODIFIED
slc-G-y lmtest/DIR_WITH_SCCS/MODIFIED_W_COMMENTS
su----- lmtest/BitKeeper/etc/attr
su----- lmtest/BitKeeper/etc/collapsed
su----- lmtest/ChangeSet
su----- lmtest/DIR_WITH_SCCS/NORMAL
su----- lmtest/DIR_WITH_SCCS/UNLOCKED
su---n- lmtest/DIR_WITH_SCCS/WRONG_NAME
su--G-- lmtest/BitKeeper/etc/config
su--G-- lmtest/BitKeeper/etc/gone
su--G-- lmtest/BitKeeper/etc/ignore
su--G-- lmtest/DIR_WITH_SCCS/GOTTEN
su-p--- lmtest/DIR_WITH_SCCS/PENDING
x------ lmtest/DIR_WITH_NO_SCCS/EXTRA2
x------ lmtest/DIR_WITH_SCCS/EXTRA3
x------ lmtest/EXTRA1
x-----y lmtest/EXTRA_WITH_COMMENTS
EOF
cd "$HERE"
bk gfiles -vixcdDGjnRup lmtest | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Test citool output from inside a repo .......................$NL
cd "$HERE/lmtest"
bk sort -k1 <<EOF > "$HERE/WANT"
x------ DIR_WITH_NO_SCCS/EXTRA2
x------ DIR_WITH_SCCS/EXTRA3
slc-G-- DIR_WITH_SCCS/MODIFIED
slc-G-y DIR_WITH_SCCS/MODIFIED_W_COMMENTS
su-p--- DIR_WITH_SCCS/PENDING
x------ EXTRA1
x-----y EXTRA_WITH_COMMENTS
EOF
bk gfiles -vgxcyp | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Test citool output from outside a repo ......................$NL
cd "$HERE"
bk sort -k1 <<EOF > "$HERE/WANT"
x------ lmtest/DIR_WITH_NO_SCCS/EXTRA2
x------ lmtest/DIR_WITH_SCCS/EXTRA3
slc-G-- lmtest/DIR_WITH_SCCS/MODIFIED
slc-G-y lmtest/DIR_WITH_SCCS/MODIFIED_W_COMMENTS
su-p--- lmtest/DIR_WITH_SCCS/PENDING
x------ lmtest/EXTRA1
x-----y lmtest/EXTRA_WITH_COMMENTS
EOF
cd "$HERE"
bk gfiles -vgxcyp lmtest | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for BK directories from root ...........................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
.
BitKeeper/etc
DIR_WITH_SCCS
EOF
bk sfiles -d | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for BK directories from root in verbose mode ...........$NL
sort <<EOF > "$HERE/WANT"
d------ .
d------ BitKeeper/etc
d------ DIR_WITH_SCCS
EOF
bk sfiles -vd | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for BK directories in argv .............................$NL
test X`bk sfiles -d DIR_WITH_SCCS` = XDIR_WITH_SCCS || fail
echo OK

echo $N Look for BK directories in stdin ............................$NL
test X`echo DIR_WITH_SCCS | bk sfiles -d -` = XDIR_WITH_SCCS || fail
echo OK

echo $N Look for non-BK directories from the root ...................$NL
cd "$HERE/lmtest"
# XXX - should this include the subrepo?
sort <<EOF > "$HERE/WANT"
BitKeeper
BitKeeper/deleted
DIR_WITH_NO_SCCS
EOF
bk sfiles -D | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for non-BK directories from the root in verbose mode ...$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
D------ BitKeeper
D------ BitKeeper/deleted
D------ DIR_WITH_NO_SCCS
EOF
bk sfiles -vD | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for non-BK directories in argv .........................$NL
test X`bk sfiles -D DIR_WITH_NO_SCCS` = XDIR_WITH_NO_SCCS || fail
echo OK

echo $N Look for non-BK directories in stdin ........................$NL
test X`echo DIR_WITH_NO_SCCS | bk sfiles -D -` = XDIR_WITH_NO_SCCS || fail
echo OK

echo $N Look for ignored files from the root ........................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
ignored.o
EOF
bk sfiles -i | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for ignored files from the root in verbose mode ........$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
i------ ignored.o
EOF
bk sfiles -vi | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for ignored files in argv ..............................$NL
test X`bk sfiles -i ignored.o` = Xignored.o || fail
echo OK

echo $N Look for ignored files in stdin .............................$NL
test X`echo ignored.o | bk sfiles -i -` = Xignored.o || fail
echo OK

echo $N Look for junk files from the root ...........................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
SCCS/JUNK
SCCS/c.NO_SFILE_NO_GFILE
EOF
bk sfiles -j | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for junk files from the root in verbose mode ...........$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
j------ SCCS/JUNK
j------ SCCS/c.NO_SFILE_NO_GFILE
EOF
bk sfiles -vj | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for junk files in argv .................................$NL
test X`bk sfiles -j SCCS/JUNK` = XSCCS/JUNK || fail
test works = not_yet && {
test X`bk sfiles -j SCCS/c.NO_SFILE_NO_GFILE` = XSCCS/c.NO_SFILE_NO_GFILE || {
	echo Yup, I thought this would fail
	exit 1
}
}
echo OK

echo $N Look for junk files in stdin ................................$NL
test X`echo SCCS/JUNK | bk sfiles -j -` = XSCCS/JUNK || fail
echo OK

echo $N Look for subrepos from the root .............................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
subrepo
EOF
bk sfiles -R | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for subrepos from the root in verbose mode .............$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
R------ subrepo
EOF
bk sfiles -vR | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

test works = not_yet && {
echo $N Look for subrepos in argv ...................................$NL
test X`bk sfiles -R subrepo` = Xsubrepo || fail
echo OK

echo $N Look for subrepos in stdin ..................................$NL
test X`echo subrepo | bk sfiles -R -` = Xsubrepo || fail
echo OK
}

echo $N Look for sfiles from the root ...............................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
BitKeeper/etc/attr
BitKeeper/etc/collapsed
BitKeeper/etc/config
BitKeeper/etc/gone
BitKeeper/etc/ignore
DIR_WITH_SCCS/GOTTEN
DIR_WITH_SCCS/LOCKED
DIR_WITH_SCCS/MODIFIED
DIR_WITH_SCCS/MODIFIED_W_COMMENTS
DIR_WITH_SCCS/NORMAL
DIR_WITH_SCCS/PENDING
DIR_WITH_SCCS/UNLOCKED
DIR_WITH_SCCS/WRONG_NAME
ChangeSet
EOF
bk gfiles -s | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for sfiles from the root in verbose mode ...............$NL
cd "$HERE/lmtest"
bk sort -k1 <<EOF > "$HERE/WANT"
su----- BitKeeper/etc/attr
su----- BitKeeper/etc/collapsed
su--G-- BitKeeper/etc/config
su--G-- BitKeeper/etc/gone
su--G-- BitKeeper/etc/ignore
su--G-- DIR_WITH_SCCS/GOTTEN
sl--G-- DIR_WITH_SCCS/LOCKED
su----- DIR_WITH_SCCS/NORMAL
su-p--- DIR_WITH_SCCS/PENDING
su----- DIR_WITH_SCCS/UNLOCKED
su----- DIR_WITH_SCCS/WRONG_NAME
su----- ChangeSet
slc-G-- DIR_WITH_SCCS/MODIFIED
slc-G-y DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -v | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for sfiles in argv .....................................$NL
test X`bk sfiles -s SCCS/s.ChangeSet` = XSCCS/s.ChangeSet || fail
test X`bk sfiles SCCS/s.ChangeSet` = XSCCS/s.ChangeSet || fail
echo OK

echo $N Look for sfiles in stdin ....................................$NL
test X`echo SCCS/s.ChangeSet | bk sfiles -s -` = XSCCS/s.ChangeSet || fail
test X`echo ChangeSet | bk sfiles -s -` = XSCCS/s.ChangeSet || fail
test X`echo SCCS/s.ChangeSet | bk sfiles -` = XSCCS/s.ChangeSet || fail
test X`echo ChangeSet | bk sfiles -` = XSCCS/s.ChangeSet || fail
echo OK

echo $N Look for extras from the root ...............................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
EXTRA1
EXTRA_WITH_COMMENTS
DIR_WITH_NO_SCCS/EXTRA2
DIR_WITH_SCCS/EXTRA3
EOF
bk gfiles -x | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for extras from the root in verbose mode ...............$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
x------ DIR_WITH_NO_SCCS/EXTRA2
x------ DIR_WITH_SCCS/EXTRA3
x------ EXTRA1
x-----y EXTRA_WITH_COMMENTS
EOF
bk sfiles -vx | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for extras in argv .....................................$NL
test X`bk sfiles -x EXTRA1` = XEXTRA1 || fail
echo OK

echo $N Look for extras in stdin ....................................$NL
test X`echo EXTRA1 | bk sfiles -x -` = XEXTRA1 || fail
echo OK

echo $N Look for all extras from the root ...........................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
DIR_WITH_NO_SCCS/EXTRA2
DIR_WITH_SCCS/EXTRA3
EXTRA1
EXTRA_WITH_COMMENTS
ignored.o
EOF
bk sfiles -ax | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

# LMXXX - we could argue that the ignored.o should be tagged "i" but we have
# not loaded the ignore db because we are in all mode.  XXX
echo $N Look for all extras from the root in verbose mode ...........$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
x------ DIR_WITH_NO_SCCS/EXTRA2
x------ DIR_WITH_SCCS/EXTRA3
x------ EXTRA1
x------ ignored.o
x-----y EXTRA_WITH_COMMENTS
EOF
bk sfiles -vax | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for all extras in argv .................................$NL
test X`bk sfiles -ax EXTRA1` = XEXTRA1 || fail
test X`bk sfiles -ax ignored.o` = Xignored.o || fail
echo OK

echo $N Look for all extras in stdin ................................$NL
test X`echo EXTRA1 | bk sfiles -ax -` = XEXTRA1 || fail
test X`echo ignored.o | bk sfiles -ax -` = Xignored.o || fail
echo OK

echo $N Look for locked sfiles from the root ........................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
DIR_WITH_SCCS/LOCKED
DIR_WITH_SCCS/MODIFIED
DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -l | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for locked sfiles from the root in verbose mode ........$NL
cd "$HERE/lmtest"
bk sort -k1 <<EOF > "$HERE/WANT"
sl--G-- DIR_WITH_SCCS/LOCKED
slc-G-- DIR_WITH_SCCS/MODIFIED
slc-G-y DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -vl | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for locked sfiles in argv ..............................$NL
test X`bk gfiles -l DIR_WITH_SCCS/LOCKED` = XDIR_WITH_SCCS/LOCKED || fail
test X`bk gfiles -l DIR_WITH_SCCS/LOCKED` = XDIR_WITH_SCCS/LOCKED || fail
echo OK

echo $N Look for locked sfiles in stdin .............................$NL
test X`echo DIR_WITH_SCCS/LOCKED | bk gfiles -l -` = XDIR_WITH_SCCS/LOCKED || fail
test X`echo DIR_WITH_SCCS/LOCKED | bk gfiles -l -` = XDIR_WITH_SCCS/LOCKED || fail
echo OK

echo $N Look for unlocked sfiles from the root ......................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
BitKeeper/etc/attr
BitKeeper/etc/collapsed
BitKeeper/etc/config
BitKeeper/etc/gone
BitKeeper/etc/ignore
ChangeSet
DIR_WITH_SCCS/GOTTEN
DIR_WITH_SCCS/NORMAL
DIR_WITH_SCCS/PENDING
DIR_WITH_SCCS/UNLOCKED
DIR_WITH_SCCS/WRONG_NAME
EOF
bk gfiles -u | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for unlocked sfiles from the root in verbose mode ......$NL
cd "$HERE/lmtest"
bk sort -k1 <<EOF > "$HERE/WANT"
su----- BitKeeper/etc/attr
su----- BitKeeper/etc/collapsed
su--G-- BitKeeper/etc/config
su--G-- BitKeeper/etc/gone
su--G-- BitKeeper/etc/ignore
su--G-- DIR_WITH_SCCS/GOTTEN
su----- DIR_WITH_SCCS/NORMAL
su-p--- DIR_WITH_SCCS/PENDING
su----- DIR_WITH_SCCS/UNLOCKED
su----- DIR_WITH_SCCS/WRONG_NAME
su----- ChangeSet
EOF
bk gfiles -vu | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for unlocked sfiles in argv ............................$NL
test X`bk gfiles -u ChangeSet` = XChangeSet || fail
test X`bk gfiles -u ChangeSet` = XChangeSet || fail
echo OK

echo $N Look for unlocked sfiles in stdin ...........................$NL
test X`echo ChangeSet | bk gfiles -u -` = XChangeSet || fail
test X`echo ChangeSet | bk gfiles -u -` = XChangeSet || fail
echo OK

echo $N Look for changed sfiles from the root .......................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
DIR_WITH_SCCS/MODIFIED
DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -c | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for changed sfiles from the root in verbose mode .......$NL
cd "$HERE/lmtest"
bk sort -k1 <<EOF > "$HERE/WANT"
slc-G-- DIR_WITH_SCCS/MODIFIED
slc-G-y DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -vc | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for changed sfiles in argv .............................$NL
test X`bk gfiles -c DIR_WITH_SCCS/MODIFIED` = XDIR_WITH_SCCS/MODIFIED || fail
test X`bk gfiles -c DIR_WITH_SCCS/MODIFIED` = XDIR_WITH_SCCS/MODIFIED || fail
echo OK

echo $N Look for changed sfiles in stdin ............................$NL
test X`echo DIR_WITH_SCCS/MODIFIED | bk gfiles -c -` = XDIR_WITH_SCCS/MODIFIED || fail
test X`echo DIR_WITH_SCCS/MODIFIED | bk gfiles -c -` = XDIR_WITH_SCCS/MODIFIED || fail
echo OK

echo $N Look for pending sfiles from the root .......................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
DIR_WITH_SCCS/PENDING
EOF
bk gfiles -p | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for pending sfiles from the root in verbose mode .......$NL
cd "$HERE/lmtest"
bk sort -k1 <<EOF > "$HERE/WANT"
su-p--- DIR_WITH_SCCS/PENDING
EOF
bk gfiles -vp | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for pending sfiles in argv .............................$NL
test X`bk gfiles -p DIR_WITH_SCCS/PENDING` = XDIR_WITH_SCCS/PENDING || fail
test X`bk gfiles -p DIR_WITH_SCCS/PENDING` = XDIR_WITH_SCCS/PENDING || fail
echo OK

echo $N Look for pending sfiles in stdin ............................$NL
test X`echo DIR_WITH_SCCS/PENDING | bk gfiles -p -` = XDIR_WITH_SCCS/PENDING || fail
test X`echo DIR_WITH_SCCS/PENDING | bk gfiles -p -` = XDIR_WITH_SCCS/PENDING || fail
echo OK

echo $N Look for gotten sfiles from the root ........................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
BitKeeper/etc/config
BitKeeper/etc/gone
BitKeeper/etc/ignore
DIR_WITH_SCCS/GOTTEN
DIR_WITH_SCCS/LOCKED
DIR_WITH_SCCS/MODIFIED
DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -G | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for gotten sfiles from the root in verbose mode ........$NL
cd "$HERE/lmtest"
bk sort -k1 <<EOF > "$HERE/WANT"
su--G-- BitKeeper/etc/config
su--G-- BitKeeper/etc/gone
su--G-- BitKeeper/etc/ignore
su--G-- DIR_WITH_SCCS/GOTTEN
sl--G-- DIR_WITH_SCCS/LOCKED
slc-G-- DIR_WITH_SCCS/MODIFIED
slc-G-y DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -vG | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for gotten sfiles in argv ..............................$NL
test X`bk gfiles -G DIR_WITH_SCCS/GOTTEN` = XDIR_WITH_SCCS/GOTTEN || fail
test X`bk gfiles -G DIR_WITH_SCCS/GOTTEN` = XDIR_WITH_SCCS/GOTTEN || fail
echo OK

echo $N Look for gotten sfiles in stdin .............................$NL
test X`echo DIR_WITH_SCCS/GOTTEN | bk gfiles -G -` = XDIR_WITH_SCCS/GOTTEN || fail
test X`echo DIR_WITH_SCCS/GOTTEN | bk gfiles -G -` = XDIR_WITH_SCCS/GOTTEN || fail
echo OK

echo $N Look for mislocated files from the root .....................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
DIR_WITH_SCCS/WRONG_NAME
EOF
bk gfiles -n | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for mislocated files from the root in verbose mode .....$NL
cd "$HERE/lmtest"
bk sort -k1 <<EOF > "$HERE/WANT"
su---n- DIR_WITH_SCCS/WRONG_NAME
EOF
bk gfiles -vn | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for mislocated files in argv ...........................$NL
test X`bk gfiles -n DIR_WITH_SCCS/WRONG_NAME` = XDIR_WITH_SCCS/WRONG_NAME || fail
test X`bk gfiles -n DIR_WITH_SCCS/WRONG_NAME` = XDIR_WITH_SCCS/WRONG_NAME || fail
echo OK

echo $N Look for mislocated files in stdin ..........................$NL
test X`echo DIR_WITH_SCCS/WRONG_NAME | bk gfiles -n -` = XDIR_WITH_SCCS/WRONG_NAME || fail
test X`echo DIR_WITH_SCCS/WRONG_NAME | bk gfiles -n -` = XDIR_WITH_SCCS/WRONG_NAME || fail
echo OK

echo $N Look for files with comments from the root ..................$NL
cd "$HERE/lmtest"
sort <<EOF > "$HERE/WANT"
DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -y | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for files with comments from the root in verbose mode ..$NL
cd "$HERE/lmtest"
bk sort -k1 <<EOF > "$HERE/WANT"
slc-G-y DIR_WITH_SCCS/MODIFIED_W_COMMENTS
x-----y EXTRA_WITH_COMMENTS
EOF
bk gfiles -vy | bk sort -k1 > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for files with comments in argv ........................$NL
test X`bk gfiles -y DIR_WITH_SCCS/MODIFIED_W_COMMENTS` = XDIR_WITH_SCCS/MODIFIED_W_COMMENTS || fail
test X`bk gfiles -y DIR_WITH_SCCS/MODIFIED_W_COMMENTS` = XDIR_WITH_SCCS/MODIFIED_W_COMMENTS || fail
echo OK

echo $N Look for files with comments in stdin .......................$NL
test X`echo DIR_WITH_SCCS/MODIFIED_W_COMMENTS | bk gfiles -y -` = XDIR_WITH_SCCS/MODIFIED_W_COMMENTS || fail
test X`echo DIR_WITH_SCCS/MODIFIED_W_COMMENTS | bk gfiles -y -` = XDIR_WITH_SCCS/MODIFIED_W_COMMENTS || fail
echo OK

# LMXXX - should do all of that with -g as well.  Oy.  
# LMXXX - should test that we don't descend into subreposities
# LMXXX - should test summary output

echo $N Look for BK directories from outside repo ...................$NL
cd "$HERE"
sort <<EOF > "$HERE/WANT"
lmtest
lmtest/BitKeeper/etc
lmtest/DIR_WITH_SCCS
EOF
bk gfiles -d lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for BK directories in argv from outside repo ...........$NL
test X`bk gfiles -d lmtest/DIR_WITH_SCCS` = Xlmtest/DIR_WITH_SCCS || fail
echo OK

echo $N Look for non-BK directories from the outside repo ...........$NL
sort <<EOF > "$HERE/WANT"
lmtest/BitKeeper
lmtest/BitKeeper/deleted
lmtest/DIR_WITH_NO_SCCS
EOF
bk gfiles -D lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for non-BK directories in argv from outside repo .......$NL
test X`bk gfiles -D lmtest/DIR_WITH_NO_SCCS` = Xlmtest/DIR_WITH_NO_SCCS || fail
echo OK

echo $N Look for ignored files from the outside repo ................$NL
sort <<EOF > "$HERE/WANT"
lmtest/ignored.o
EOF
bk gfiles -i lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for ignored files in argv from outside repo ............$NL
test X`bk gfiles -i lmtest/ignored.o` = Xlmtest/ignored.o || fail
echo OK

echo $N Look for junk files from the outside repo ...................$NL
sort <<EOF > "$HERE/WANT"
lmtest/SCCS/JUNK
lmtest/SCCS/c.NO_SFILE_NO_GFILE
EOF
bk gfiles -j lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for junk files in argv from outside repo ...............$NL
test X`bk gfiles -j lmtest/SCCS/JUNK` = Xlmtest/SCCS/JUNK || fail
test works = not_yet && {
test X`bk gfiles -j lmtest/SCCS/c.NO_SFILE_NO_GFILE` = Xlmtest/SCCS/c.NO_SFILE_NO_GFILE || {
	echo Yup, I thought this would fail
	exit 1
}
}
echo OK

echo $N Look for subrepos from the outside repo .....................$NL
sort <<EOF > "$HERE/WANT"
lmtest/subrepo
EOF
bk gfiles -R lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

test works = not_yet && {
echo $N Look for subrepos in argv from outside repo .................$NL
test X`bk gfiles -R lmtest/subrepo` = Xlmtest/subrepo || fail
echo OK
}

echo $N Look for gfiles from the outside repo .......................$NL
sort <<EOF > "$HERE/WANT"
lmtest/BitKeeper/etc/attr
lmtest/BitKeeper/etc/collapsed
lmtest/BitKeeper/etc/config
lmtest/BitKeeper/etc/gone
lmtest/BitKeeper/etc/ignore
lmtest/DIR_WITH_SCCS/GOTTEN
lmtest/DIR_WITH_SCCS/LOCKED
lmtest/DIR_WITH_SCCS/MODIFIED
lmtest/DIR_WITH_SCCS/MODIFIED_W_COMMENTS
lmtest/DIR_WITH_SCCS/NORMAL
lmtest/DIR_WITH_SCCS/PENDING
lmtest/DIR_WITH_SCCS/UNLOCKED
lmtest/DIR_WITH_SCCS/WRONG_NAME
lmtest/ChangeSet
EOF
bk gfiles lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for sfiles in argv from outside repo ...................$NL
test X`bk gfiles -s lmtest/SCCS/s.ChangeSet` = Xlmtest/ChangeSet || fail
test X`bk gfiles lmtest/ChangeSet` = Xlmtest/ChangeSet || fail
echo OK

echo $N Look for extra files from the outside repo ..................$NL
sort <<EOF > "$HERE/WANT"
lmtest/EXTRA1
lmtest/EXTRA_WITH_COMMENTS
lmtest/DIR_WITH_NO_SCCS/EXTRA2
lmtest/DIR_WITH_SCCS/EXTRA3
EOF
bk gfiles -x lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for extra files in argv from outside repo ..............$NL
test X`bk gfiles -x lmtest/EXTRA1` = Xlmtest/EXTRA1 || fail
echo OK

echo $N Look for all extras from the outside repo ...................$NL
sort <<EOF > "$HERE/WANT"
lmtest/DIR_WITH_NO_SCCS/EXTRA2
lmtest/DIR_WITH_SCCS/EXTRA3
lmtest/EXTRA1
lmtest/EXTRA_WITH_COMMENTS
lmtest/ignored.o
EOF
bk gfiles -ax lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for all extras in argv from outside repo ...............$NL
test X`bk gfiles -ax lmtest/EXTRA1` = Xlmtest/EXTRA1 || fail
test X`bk gfiles -ax lmtest/ignored.o` = Xlmtest/ignored.o || fail
echo OK

echo $N Look for locked sfiles from the outside repo ................$NL
sort <<EOF > "$HERE/WANT"
lmtest/DIR_WITH_SCCS/LOCKED
lmtest/DIR_WITH_SCCS/MODIFIED
lmtest/DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -l lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for locked gfiles in argv from outside repo ............$NL
test X`bk gfiles -ls lmtest/DIR_WITH_SCCS/SCCS/s.LOCKED` = Xlmtest/DIR_WITH_SCCS/LOCKED || fail
test X`bk gfiles -l lmtest/DIR_WITH_SCCS/LOCKED` = Xlmtest/DIR_WITH_SCCS/LOCKED || fail
echo OK

echo $N Look for unlocked gfiles from the outside repo ..............$NL
sort <<EOF > "$HERE/WANT"
lmtest/BitKeeper/etc/attr
lmtest/BitKeeper/etc/collapsed
lmtest/BitKeeper/etc/config
lmtest/BitKeeper/etc/gone
lmtest/BitKeeper/etc/ignore
lmtest/DIR_WITH_SCCS/GOTTEN
lmtest/DIR_WITH_SCCS/NORMAL
lmtest/DIR_WITH_SCCS/PENDING
lmtest/DIR_WITH_SCCS/UNLOCKED
lmtest/DIR_WITH_SCCS/WRONG_NAME
lmtest/ChangeSet
EOF
bk gfiles -u lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for unlocked sfiles in argv from outside repo ..........$NL
test X`bk gfiles -us lmtest/SCCS/s.ChangeSet` = Xlmtest/ChangeSet || fail
test X`bk gfiles -u lmtest/ChangeSet` = Xlmtest/ChangeSet || fail
echo OK

echo $N Look for changed sfiles from the outside repo ...............$NL
sort <<EOF > "$HERE/WANT"
lmtest/DIR_WITH_SCCS/MODIFIED
lmtest/DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -c lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for changed sfiles in argv from outside repo ...........$NL
test X`bk gfiles -sc lmtest/DIR_WITH_SCCS/SCCS/s.MODIFIED` = Xlmtest/DIR_WITH_SCCS/MODIFIED || fail
test X`bk gfiles -c lmtest/DIR_WITH_SCCS/MODIFIED` = Xlmtest/DIR_WITH_SCCS/MODIFIED || fail
echo OK

echo $N Look for pending sfiles from the outside repo ...............$NL
sort <<EOF > "$HERE/WANT"
lmtest/DIR_WITH_SCCS/PENDING
EOF
bk gfiles -p lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for pending sfiles in argv from outside repo ...........$NL
test X`bk gfiles -p lmtest/DIR_WITH_SCCS/SCCS/s.PENDING` = Xlmtest/DIR_WITH_SCCS/PENDING || fail
test X`bk gfiles -sp lmtest/DIR_WITH_SCCS/PENDING` = Xlmtest/DIR_WITH_SCCS/PENDING || fail
echo OK

echo $N Look for gotten sfiles from the outside repo ................$NL
sort <<EOF > "$HERE/WANT"
lmtest/BitKeeper/etc/config
lmtest/BitKeeper/etc/gone
lmtest/BitKeeper/etc/ignore
lmtest/DIR_WITH_SCCS/GOTTEN
lmtest/DIR_WITH_SCCS/LOCKED
lmtest/DIR_WITH_SCCS/MODIFIED
lmtest/DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -G lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for gotten sfiles in argv from outside repo ............$NL
test X`bk gfiles -G lmtest/DIR_WITH_SCCS/GOTTEN` = Xlmtest/DIR_WITH_SCCS/GOTTEN || fail
test X`bk gfiles -sG lmtest/DIR_WITH_SCCS/GOTTEN` = Xlmtest/DIR_WITH_SCCS/GOTTEN || fail
echo OK

echo $N Look for mislocated files from the outside repo .............$NL
sort <<EOF > "$HERE/WANT"
lmtest/DIR_WITH_SCCS/WRONG_NAME
EOF
bk gfiles -n lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for mislocated files in argv from outside repo .........$NL
test X`bk gfiles -sn lmtest/DIR_WITH_SCCS/SCCS/s.WRONG_NAME` = Xlmtest/DIR_WITH_SCCS/WRONG_NAME || fail
test X`bk gfiles -n lmtest/DIR_WITH_SCCS/WRONG_NAME` = Xlmtest/DIR_WITH_SCCS/WRONG_NAME || fail
echo OK

echo $N Look for files with comments from the outside repo ..........$NL
sort <<EOF > "$HERE/WANT"
lmtest/DIR_WITH_SCCS/MODIFIED_W_COMMENTS
EOF
bk gfiles -y lmtest | sort > "$HERE/GOT"
cmpfiles "$HERE/WANT" "$HERE/GOT"
echo OK

echo $N Look for files with comments in argv from outside repo ......$NL
test X`bk gfiles -sy lmtest/DIR_WITH_SCCS/SCCS/s.MODIFIED_W_COMMENTS` = Xlmtest/DIR_WITH_SCCS/MODIFIED_W_COMMENTS || fail
test X`bk gfiles -y lmtest/DIR_WITH_SCCS/MODIFIED_W_COMMENTS` = Xlmtest/DIR_WITH_SCCS/MODIFIED_W_COMMENTS || fail
echo OK

# LMXXX - should do all of that with -g as well.  Oy.  
# LMXXX - should test that we don't descend into subreposities
# LMXXX - should test summary output

echo $N Sfiles white box test of .bk_skip in non-sccs directory .....$NL
cd "$HERE"
rm -rf project
commercial project
mkdir test
cd test
touch .a .b .bk_skip .c a b c
cd ..
cat <<EOF > WANT
GOT
WANT
EOF
bk -r gfiles -x > GOT
checkfiles WANT GOT
echo OK

echo $N Sfiles white box test of .bk_skip in sccs directory .........$NL
cd test
bk new $Q a
cd ..
bk -r gfiles -x > GOT
checkfiles WANT GOT
echo OK

echo $N Test directory ignore patterns ..............................$NL
mkdir skip
mkdir -p sub/skip
touch skip/1
touch sub/skip/2
bk edit $Q BitKeeper/etc/ignore || fail
cat <<EOF >WANT
GOT
WANT
skip/1
sub/skip/2
EOF
bk gfiles -x > GOT
cmpfiles WANT GOT
echo 'skip/*' > BitKeeper/etc/ignore
cat <<EOF >WANT
GOT
WANT
sub/skip/2
EOF
bk gfiles -x > GOT
cmpfiles WANT GOT
echo '*/skip/*' > BitKeeper/etc/ignore
cat <<EOF >WANT
GOT
WANT
EOF
bk gfiles -x > GOT
cmpfiles WANT GOT
echo '*/skip' > BitKeeper/etc/ignore
cat <<EOF >WANT
GOT
WANT
skip/1
sub/skip/2
EOF
bk gfiles -x > GOT
cmpfiles WANT GOT
echo 'skip' > BitKeeper/etc/ignore
cat <<EOF >WANT
GOT
WANT
skip/1
sub/skip/2
EOF
bk gfiles -x > GOT
cmpfiles WANT GOT
echo '*/skip' > BitKeeper/etc/ignore
cat <<EOF >WANT
GOT
WANT
EOF
BK_IGNOREDIRS=1 bk gfiles -x > GOT
cmpfiles WANT GOT
echo 'skip' > BitKeeper/etc/ignore
cat <<EOF >WANT
GOT
WANT
EOF
BK_IGNOREDIRS=1 bk gfiles -x > GOT
cmpfiles WANT GOT
echo OK

echo $N Test directory prune patterns ...............................$NL
cat <<EOF >WANT
GOT
WANT
skip/1
sub/skip/2
EOF
bk gfiles -x > GOT
cmpfiles WANT GOT
echo 'skip -prune' > BitKeeper/etc/ignore
cat <<EOF >WANT
GOT
WANT
sub/skip/2
EOF
bk gfiles -x > GOT
cmpfiles WANT GOT
echo '*/skip -prune' > BitKeeper/etc/ignore
cat <<EOF >WANT
GOT
WANT
EOF
bk gfiles -x > GOT
cmpfiles WANT GOT
echo OK

echo $N Check that '*/file' ignores files at repo root ................$NL
echo '*/junk' > BitKeeper/etc/ignore
touch junk
bk gfiles -x > GOT
cat <<EOF >WANT
GOT
WANT
skip/1
sub/skip/2
EOF
bk gfiles -x > GOT
cmpfiles WANT GOT
echo OK

echo $N Check that gfiles -U path supresses BK files ................$NL
bk gfiles -U "$PWD" | grep ChangeSet > OUT
# this will fail if the above repo has triggers
bk gfiles -U "$PWD" | fgrep 'BitKeeper/' >> OUT
test -s OUT && {
	echo failed
	cat OUT
	exit 1
}
echo OK

echo $N Check sfiles --gui ..........................................$NL
cd "$HERE/project"
bk sfiles --gui -vgcyp -x > GOT
cat > WANT <<EOF
F|x------ GOT
F|x------ OUT
F|x------ WANT
P|1 3 0 0
F|slc-G-- BitKeeper/etc/ignore
P|6 3 0 1
F|x------ skip/1
P|6 4 0 1
F|x------ sub/skip/2
P|6 5 0 1
EOF
cmpfiles WANT GOT
echo OK

echo $N Check sfiles --gui --no-progress ............................$NL
cd "$HERE/project"
bk sfiles --gui --no-progress -vgcyp -x > GOT
cat > WANT <<EOF
F|x------ GOT
F|x------ OUT
F|x------ WANT
F|slc-G-- BitKeeper/etc/ignore
F|x------ skip/1
F|x------ sub/skip/2
EOF
cmpfiles WANT GOT
echo OK

test $PLATFORM != WIN32 && {

echo $N Check sfiles -v does not dump core on an unreadable binary ..$NL
cd "$HERE"
rm project/test/.bk_skip
# ASCII is needed in order to have a pfile; otherwise, magic pfile is used
bk clone $Q --no-bk-sfile project downgrade
cd downgrade
perl -e 'printf "a\000b\n"' > binary_file
bk new $Q binary_file
bk edit $Q binary_file
chmod 000 binary_file
bk gfiles -v binary_file >OUT 2>ERR && fail
grep -iq "binary_file: Permission denied" ERR || {
	echo failed
	cat ERR
	exit 1
}
# any file causing an error in relation to -c will be listed as -c output
echo "slcpG-- binary_file" > WANT
cmpfiles WANT OUT
echo OK
}

echo $N Check that sfiles -pA can handle multiple csetmarks .........$NL
cd "$HERE"
commercial remote
touch foo bar
bk new $Q foo
bk commit $Q -yfoo
bk clone $Q . ../local
bk rm -f BitKeeper/etc/gone
echo info@bitmover.com > BitKeeper/etc/gone
bk new $Q BitKeeper/etc/gone
bk edit $Q foo
bk delta $Q -fyfoo foo
bk commit $Q -yfoo
cd ../local
bk edit $Q foo BitKeeper/etc/gone
echo data@bitmover.com > BitKeeper/etc/gone
bk delta $Q -fyfoo foo BitKeeper/etc/gone
bk commit $Q -yfoo
mkdir BitKeeper/triggers
cat <<EOF > BitKeeper/triggers/pre-commit
#!/bin/sh
exit 1
EOF
chmod +x BitKeeper/triggers/pre-commit
bk pull $Q 2> ERR && fail -f ERR
grep -q 'Trigger "pre-commit"' ERR || fail -f ERR
cd RESYNC
bk sfiles -pA foo BitKeeper/etc/gone > GOT
cat <<EOF > WANT
SCCS/s.foo|1.3
BitKeeper/etc/SCCS/s.gone|1.6
BitKeeper/etc/SCCS/s.gone|1.0.1.1
BitKeeper/etc/SCCS/s.gone|1.5
BitKeeper/etc/SCCS/s.gone|1.4
BitKeeper/etc/SCCS/s.gone|1.3
BitKeeper/etc/SCCS/s.gone|1.1.1.2
EOF
cmpfiles WANT GOT
echo OK

echo $N Try to trip up the timestampDB ..............................$NL
if [ $PLATFORM != "WIN32" ]
then
cd "$HERE"
BK_CONFIG='clock_skew:zero!'
export BK_CONFIG
commercial time
echo hi > file
bk new $Q file
bk commit $Q -ynew || fail
bk edit $Q file
echo junk >> file
chmod 000 .bk/SCCS/file,p
bk sfiles -c > OUT 2>ERR && fail -f OUT should fail
echo "SCCS/s.file" > WANT.sfile
cmpfiles WANT.sfile OUT
cat <<EOF > WANT
Empty p.file SCCS/s.file - aborted.
EOF
cmpfiles WANT ERR
chmod 0660 .bk/SCCS/file,p
bk sfiles -c > OUT || fail -f OUT should work
cmpfiles WANT.sfile OUT
echo OK
else
echo skipped
fi

echo $N Test --gfiles-opts ..........................................$NL
cd "`bk root`"
bk gfiles -v --cold > WANT
bk -r --gfiles-opts='-v --cold' > GOT
cmpfiles WANT GOT
echo OK
